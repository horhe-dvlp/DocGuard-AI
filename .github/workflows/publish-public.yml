name: Publish to public repo

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-filter-repo
        run: |
          python -m pip install --upgrade pip
          pip install git-filter-repo

      - name: Filter out private directories and sensitive files
        run: |
          set -euxo pipefail
          # Filter private directories
          git filter-repo --path-glob '*/private/*' --invert-paths --force
          git filter-repo --path private/ --invert-paths --force
          # Filter sensitive files
          git filter-repo --path-glob '*.key' --invert-paths --force
          git filter-repo --path-glob '*.pem' --invert-paths --force
          git filter-repo --path-glob '*secret*' --invert-paths --force
          git filter-repo --path-glob '*.private' --invert-paths --force
          git filter-repo --path-glob 'config/local.*' --invert-paths --force
          git filter-repo --path-glob 'config/production.*' --invert-paths --force
          git filter-repo --path-glob 'credentials/' --invert-paths --force

      - name: Check Deploy Key availability
        id: check_deploy_key
        run: |
          if [ -n "${{ secrets.PUBLIC_DEPLOY_KEY }}" ]; then
            echo "deploy_key_available=true" >> $GITHUB_OUTPUT
            echo "Deploy key is available"
          else
            echo "deploy_key_available=false" >> $GITHUB_OUTPUT
            echo "Deploy key is not set"
          fi

      - name: Setup SSH Deploy Key
        if: steps.check_deploy_key.outputs.deploy_key_available == 'true'
        env:
          SSH_KEY: ${{ secrets.PUBLIC_DEPLOY_KEY }}
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Handle deploy key with proper line breaks
          echo "Setting up deploy key..."
          
          # Save the key using environment variable (better for secrets)
          echo "$SSH_KEY" > /tmp/deploy_key_raw
          
          # Debug: show key structure
          echo "Key file size: $(wc -c < /tmp/deploy_key_raw) bytes"
          echo "Key file lines: $(wc -l < /tmp/deploy_key_raw)"
          echo "Key starts with: $(head -c 30 /tmp/deploy_key_raw)"
          echo "Key ends with: $(tail -c 30 /tmp/deploy_key_raw)"
          
          # Check if key already has proper format
          if grep -q "BEGIN.*PRIVATE KEY" /tmp/deploy_key_raw && grep -q "END.*PRIVATE KEY" /tmp/deploy_key_raw; then
            echo "Key appears to have proper format"
            
            # But check if it's actually multiline
            LINES_COUNT=$(wc -l < /tmp/deploy_key_raw)
            if [ "$LINES_COUNT" -eq 1 ]; then
              echo "Key is in single line format, need to fix line breaks"
              # Force reconstruction even if headers are present
              KEY_CONTENT=$(cat /tmp/deploy_key_raw | tr -d '\n' | tr -d '\r')
              
              if echo "$KEY_CONTENT" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
                echo "Reconstructing OpenSSH format key with proper line breaks"
                # Extract just the key content between headers
                KEY_BODY=$(echo "$KEY_CONTENT" | sed 's/.*-----BEGIN OPENSSH PRIVATE KEY-----//' | sed 's/-----END OPENSSH PRIVATE KEY-----.*//')
                echo "-----BEGIN OPENSSH PRIVATE KEY-----" > ~/.ssh/deploy_key
                echo "$KEY_BODY" | fold -w 70 >> ~/.ssh/deploy_key
                echo "-----END OPENSSH PRIVATE KEY-----" >> ~/.ssh/deploy_key
              elif echo "$KEY_CONTENT" | grep -q "BEGIN RSA PRIVATE KEY"; then
                echo "Reconstructing RSA format key with proper line breaks"
                KEY_BODY=$(echo "$KEY_CONTENT" | sed 's/.*-----BEGIN RSA PRIVATE KEY-----//' | sed 's/-----END RSA PRIVATE KEY-----.*//')
                echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key
                echo "$KEY_BODY" | fold -w 64 >> ~/.ssh/deploy_key
                echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
              else
                echo "Unknown key format in single line"
                echo "$SSH_KEY" > ~/.ssh/deploy_key
              fi
            else
              echo "Key already has multiple lines, copying as-is"
              echo "$SSH_KEY" > ~/.ssh/deploy_key
            fi
          else
            echo "Key might be missing line breaks, attempting to fix..."
            # Try to reconstruct proper SSH key format
            KEY_CONTENT=$(cat /tmp/deploy_key_raw | tr -d '\n' | tr -d '\r')
            
            # Check for different key formats and reconstruct
            if echo "$KEY_CONTENT" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
              echo "Detected OpenSSH format key"
              echo "-----BEGIN OPENSSH PRIVATE KEY-----" > ~/.ssh/deploy_key
              echo "$KEY_CONTENT" | sed 's/-----BEGIN OPENSSH PRIVATE KEY-----//' | sed 's/-----END OPENSSH PRIVATE KEY-----//' | fold -w 70 >> ~/.ssh/deploy_key
              echo "-----END OPENSSH PRIVATE KEY-----" >> ~/.ssh/deploy_key
            elif echo "$KEY_CONTENT" | grep -q "BEGIN RSA PRIVATE KEY"; then
              echo "Detected RSA format key"
              echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key
              echo "$KEY_CONTENT" | sed 's/-----BEGIN RSA PRIVATE KEY-----//' | sed 's/-----END RSA PRIVATE KEY-----//' | fold -w 64 >> ~/.ssh/deploy_key
              echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
            elif echo "$KEY_CONTENT" | grep -q "BEGIN EC PRIVATE KEY"; then
              echo "Detected EC format key"
              echo "-----BEGIN EC PRIVATE KEY-----" > ~/.ssh/deploy_key
              echo "$KEY_CONTENT" | sed 's/-----BEGIN EC PRIVATE KEY-----//' | sed 's/-----END EC PRIVATE KEY-----//' | fold -w 64 >> ~/.ssh/deploy_key
              echo "-----END EC PRIVATE KEY-----" >> ~/.ssh/deploy_key
            else
              echo "Error: Could not detect SSH key format"
              echo "Raw key preview (first 100 chars): $(echo "$KEY_CONTENT" | head -c 100)"
              exit 1
            fi
          fi
          
          # Set proper permissions
          chmod 600 ~/.ssh/deploy_key
          
          # Verify the final key structure
          echo "Final key info:"
          echo "Lines in key: $(wc -l < ~/.ssh/deploy_key)"
          echo "Key size: $(wc -c < ~/.ssh/deploy_key) bytes"
          
          # Clean up temporary file
          rm -f /tmp/deploy_key_raw
          
          # Try ssh-keygen verification
          if ssh-keygen -l -f ~/.ssh/deploy_key 2>/dev/null; then
            echo "Key format verification successful!"
            KEY_FILE="/home/runner/.ssh/deploy_key"
          else
            echo "Key format verification failed, but continuing anyway"
            KEY_FILE="/home/runner/.ssh/deploy_key"
          fi
          
          # Add GitHub to known hosts
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Set up SSH config to use the key
          echo "Host github.com" > ~/.ssh/config
          echo "  HostName github.com" >> ~/.ssh/config
          echo "  User git" >> ~/.ssh/config
          echo "  IdentityFile $KEY_FILE" >> ~/.ssh/config
          echo "  IdentitiesOnly yes" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -T git@github.com || echo "SSH test completed (exit code $?)"

      - name: Push via SSH Deploy Key
        if: steps.check_deploy_key.outputs.deploy_key_available == 'true'
        env:
          SSH_REPO_URL: "git@github.com:horhe-dvlp/DocGuard-AI.git"
        run: |
          set -euxo pipefail
          
          echo "Using SSH Deploy Key method"
          echo "Target repository: $SSH_REPO_URL"
          
          # Add remote
          git remote add public-ssh "$SSH_REPO_URL"
          
          # Push to repository
          echo "Pushing to public repository via SSH..."
          git push --force public-ssh HEAD:main
          
          echo "Pushing tags..."
          git push --force public-ssh --tags || echo "No tags to push"
          
          echo "Successfully published to public repository!"

