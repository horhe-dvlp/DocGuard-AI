name: Publish to public repo

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-filter-repo
        run: |
          python -m pip install --upgrade pip
          pip install git-filter-repo

      - name: Filter out private directories and sensitive files
        run: |
          set -euxo pipefail
          # Filter private directories
          git filter-repo --path-glob '*/private/*' --invert-paths --force
          git filter-repo --path private/ --invert-paths --force
          # Filter sensitive files
          git filter-repo --path-glob '*.key' --invert-paths --force
          git filter-repo --path-glob '*.pem' --invert-paths --force
          git filter-repo --path-glob '*secret*' --invert-paths --force
          git filter-repo --path-glob '*.private' --invert-paths --force
          git filter-repo --path-glob 'config/local.*' --invert-paths --force
          git filter-repo --path-glob 'config/production.*' --invert-paths --force
          git filter-repo --path-glob 'credentials/' --invert-paths --force

      - name: Check Deploy Key availability
        id: check_deploy_key
        run: |
          if [ -n "${{ secrets.PUBLIC_DEPLOY_KEY }}" ]; then
            echo "deploy_key_available=true" >> $GITHUB_OUTPUT
            echo "Deploy key is available"
          else
            echo "deploy_key_available=false" >> $GITHUB_OUTPUT
            echo "Deploy key is not set"
          fi

      - name: Setup SSH Deploy Key
        if: steps.check_deploy_key.outputs.deploy_key_available == 'true'
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Handle deploy key with proper line breaks
          echo "Setting up deploy key..."
          
          # Save the key to a temporary file and fix line breaks
          echo "${{ secrets.PUBLIC_DEPLOY_KEY }}" > /tmp/deploy_key_raw
          
          # Check if key already has proper format
          if grep -q "BEGIN.*PRIVATE KEY" /tmp/deploy_key_raw && grep -q "END.*PRIVATE KEY" /tmp/deploy_key_raw; then
            echo "Key appears to have proper format"
            cp /tmp/deploy_key_raw ~/.ssh/id_ed25519
          else
            echo "Key might be missing line breaks, attempting to fix..."
            # Try to reconstruct proper SSH key format
            KEY_CONTENT=$(cat /tmp/deploy_key_raw | tr -d '\n' | tr -d '\r')
            
            # Check for ed25519 key format
            if echo "$KEY_CONTENT" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
              echo "Detected OpenSSH format key"
              echo "-----BEGIN OPENSSH PRIVATE KEY-----" > ~/.ssh/id_ed25519
              echo "$KEY_CONTENT" | sed 's/-----BEGIN OPENSSH PRIVATE KEY-----//' | sed 's/-----END OPENSSH PRIVATE KEY-----//' | fold -w 64 >> ~/.ssh/id_ed25519
              echo "-----END OPENSSH PRIVATE KEY-----" >> ~/.ssh/id_ed25519
            elif echo "$KEY_CONTENT" | grep -q "BEGIN RSA PRIVATE KEY"; then
              echo "Detected RSA format key"
              echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/id_ed25519
              echo "$KEY_CONTENT" | sed 's/-----BEGIN RSA PRIVATE KEY-----//' | sed 's/-----END RSA PRIVATE KEY-----//' | fold -w 64 >> ~/.ssh/id_ed25519
              echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/id_ed25519
            elif echo "$KEY_CONTENT" | grep -q "BEGIN EC PRIVATE KEY"; then
              echo "Detected EC format key"
              echo "-----BEGIN EC PRIVATE KEY-----" > ~/.ssh/id_ed25519
              echo "$KEY_CONTENT" | sed 's/-----BEGIN EC PRIVATE KEY-----//' | sed 's/-----END EC PRIVATE KEY-----//' | fold -w 64 >> ~/.ssh/id_ed25519
              echo "-----END EC PRIVATE KEY-----" >> ~/.ssh/id_ed25519
            else
              echo "Error: Could not detect SSH key format"
              echo "Raw key preview (first 100 chars): $(echo "$KEY_CONTENT" | head -c 100)..."
              exit 1
            fi
          fi
          
          # Set proper permissions
          chmod 600 ~/.ssh/id_ed25519
          
          # Verify key format
          echo "Verifying key format..."
          if ssh-keygen -l -f ~/.ssh/id_ed25519 2>/dev/null; then
            echo "Key format verification successful"
          else
            echo "Key format verification failed"
            echo "Key file contents preview:"
            head -3 ~/.ssh/id_ed25519
            echo "..."
            tail -3 ~/.ssh/id_ed25519
            exit 1
          fi
          
          # Clean up temporary file
          rm -f /tmp/deploy_key_raw
          
          # Add GitHub to known hosts
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -T git@github.com || echo "SSH test completed (exit code $?)"
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push via SSH Deploy Key
        if: steps.check_deploy_key.outputs.deploy_key_available == 'true'
        env:
          SSH_REPO_URL: "git@github.com:horhe-dvlp/DocGuard-AI.git"
        run: |
          set -euxo pipefail
          
          echo "Using SSH Deploy Key method"
          echo "Target repository: $SSH_REPO_URL"
          
          # Add remote
          git remote add public-ssh "$SSH_REPO_URL"
          
          # Push to repository
          echo "Pushing to public repository via SSH..."
          git push --force public-ssh HEAD:main
          
          echo "Pushing tags..."
          git push --force public-ssh --tags || echo "No tags to push"
          
          echo "Successfully published to public repository!"

